<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cosmo Blasters - Scanner & Value Updates + Background</title>
  <style>
    body { margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#000; color:#fff; font-family:Arial, sans-serif; overflow:hidden; }
    #startScreen{ text-align:center; }
    #startButton{ background:#4CAF50; border:none; padding:12px 22px; font-size:18px; color:#fff; border-radius:10px; cursor:pointer; }
    #gameArea{
      position:relative;
      width:900px; max-width:95vw; height:560px;
      background-image: url('stockSpaceBackground.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border:3px solid #555; border-radius:10px; display:none; overflow:hidden; box-sizing:border-box;
    }
    #gameArea::after{ content:""; position:absolute; inset:0; background:linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)); pointer-events:none; z-index:1; border-radius:10px; }

    #menuBar{ display:flex; justify-content:space-around; align-items:center; background:#333; border-bottom:2px solid #555; height:50px; z-index:30; position:relative; }
    .menuButton{ background:#444; border:none; color:white; font-size:14px; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .menuButton:hover{ background:#555; }
    
    .settings-menu { display: none; position: absolute; top: 60px; right: 100px; background-color: #141428;border: 2px solid #3a3a6a; border-radius: 10px; padding: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); z-index: 20;
}

.settings-menu button {  display: block; width: 100%; background: none; border: none; color: #fff; font-size: 14px; text-align: left; padding: 8px 12px; border-radius: 6px; cursor: pointer;
}

.settings-menu button:hover {
  background-color: #303060;
}
    .circle{ position:absolute; width:48px; height:48px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; z-index:20; user-select:none; box-shadow:0 4px 10px rgba(0,0,0,0.6); }
    .hp-bar{ position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); width:44px; height:7px; background:rgba(0,0,0,0.35); border-radius:4px; overflow:hidden; border:1px solid rgba(255,255,255,0.06); }
    .hp-bar-inner{ height:100%; width:100%; transform-origin:left center; transition:width .06s linear; background:linear-gradient(90deg,#ff6b6b,#f39c12); }

    #statsMenu{ opacity:.95; background:#1a1a1a; border:2px solid #555; border-radius:8px; padding:12px; display:none; position:absolute; top:60px; left:14px; width:300px; z-index:40; box-sizing:border-box; }
    .stat-card{ border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:8px; background:rgba(39,39,39,0.12); margin-bottom:8px; }

    /* ---- STORE (restored simpler style) ---- */
    #storeMenu {
      opacity: .8;
      background-color: #1a1a1a;
      border: 2px solid #555;
      border-radius: 8px;
      margin: 20px;
      padding: 15px;
      text-align: center;
      display: none;
      z-index: 3;
      position: relative;
      box-sizing: border-box;
      width: auto;
    }
    .store-section { margin-bottom: 16px; text-align:left; max-width:420px; margin-left:auto; margin-right:auto; }
    .buyButton { background-color:#333; color:white; border:1px solid #666; padding:10px 12px; margin:5px 0; border-radius:6px; cursor:pointer; width:100%; text-align:left; }
    .buyButton:hover { background-color:#555; }
    .buyButton:disabled { opacity:0.6; cursor:default; background-color:#2b2b2b; color:#bbb; border-color:#444; }

    #achievementsMenu{ position:absolute; top:50px; left:20px; right:20px; bottom:60px; background:rgba(20,20,20,0.95); border:2px solid #555; border-radius:8px; padding:14px; display:none; z-index:50; box-sizing:border-box; overflow:hidden; }
    #achievementsList{ position:absolute; top:48px; left:14px; bottom:14px; right:14px; overflow-y:auto; display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    .achievement-card{ border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:10px; background:rgba(39,39,39,0.12); min-height:72px; display:flex; flex-direction:column; justify-content:space-between; }
    .claimButton{ background:#333; color:#fff; border:1px solid #666; padding:6px 10px; border-radius:6px; cursor:pointer;}
    .claimButton:disabled{ opacity:.45; cursor:default; }

    #secretsPanel{ position:absolute; top:0; bottom:0; width:420px; right:-460px; background:linear-gradient(180deg,#141414,#1e1e1e); border-left:2px solid #444; padding:12px; box-sizing:border-box; transition:right 350ms cubic-bezier(.2,.9,.25,1); z-index:60; display:flex; flex-direction:column; }
    #secretsPanel.open{ right:14px; }
    .secret-card{ display:flex; gap:8px; align-items:center; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:8px; margin-bottom:8px; background:rgba(35,35,35,0.08); }
    .secret-image{ width:64px; height:48px; border-radius:6px; background:#111; display:flex; align-items:center; justify-content:center; font-size:28px; }
    .secret-title{ font-weight:bold; font-size:13px; }
    .secret-sub{ font-size:12px; opacity:.8; }

    #moneyDisplay{ position:absolute; bottom:10px; left:18px; font-size:20px; z-index:40; }

    @media (max-width:980px){ #achievementsList{ grid-template-columns:repeat(1,1fr); } #statsMenu{ width:42vw; } #storeMenu{ width:86vw; margin:8px; } }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>Cosmo Blasters Prototype</h1>
    <button id="startButton">Start Game</button>
  </div>

  <div id="gameArea">
    <div id="menuBar">
      <button class="menuButton" id="shopToggle">Shop</button>
      <button class="menuButton" id="statsToggle">Stats</button>
      <button class="menuButton" id="achToggle">Achievements</button>
      <button class="menuButton" id="settingsBtn">Settings</button>
    <div id="settingsMenu" class="settings-menu">
        <button class="menuButton" id="saveButton"> Save</button>
        <button id="pauseButton"> Pause</button>
        <button id="restartButton"> Restart</button>
</div>
    </div>

    <div id="restartConfirm" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a1a; border:2px solid #555; border-radius:8px; padding:16px; text-align:center; z-index:100;">
  <div style="margin-bottom:12px;">Are you sure you want to restart?</div>
  <button id="confirmYes" class="menuButton" style="margin-right:8px;">Yes</button>
  <button id="confirmNo" class="menuButton">No</button>
</div>


    <!-- Achievements & Secrets -->
    <div id="achievementsMenu">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:bold">Achievements</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-size:13px;opacity:.9">Rewards = Money</div>
          <button id="closeAchievements" class="menuButton" style="padding:6px 10px">Close</button>
        </div>
      </div>

      <div id="achievementsList"></div>

      <div id="achFooter" style="position:absolute;right:18px;bottom:8px;display:flex;gap:8px;">
        <button id="viewSecretsBtn" class="menuButton">View Secrets</button>
      </div>

      <div id="secretsPanel" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:bold">Secrets</div>
          <button id="closeSecrets" class="menuButton" style="padding:6px 10px">Back</button>
        </div>
        <div id="secretsList" style="overflow:auto;padding-right:6px;"></div>
      </div>
    </div>

    <div id="statsMenu">
      <div class="stat-card"><div>Total Money Earned:</div><div id="totalMoneyEarned">0</div></div>
      <div class="stat-card"><div>Money Spent:</div><div id="moneySpent">0</div></div>
      <div class="stat-card"><div>Asteroids Destroyed:</div><div id="asteroidsDestroyed">0</div></div>
      <div class="stat-card"><div>Upgrades Purchased:</div><div id="upgradesPurchased">0</div></div>
      <div class="stat-card"><div>Time Played:</div><div id="timePlayed">0s</div></div>
    </div>

    <!-- ---- STORE (restored style) ---- -->
    <div id="storeMenu">
      <h2>Store Upgrades</h2>

      <div class="store-section">
        <h3>Weapon Upgrades (increases damage)</h3>
        <button class="buyButton" data-type="weapon" data-cost="10" data-level="1">Laser Lv1 - $10</button>
      </div>

      <div class="store-section">
        <h3>Scanner Upgrades (unlock rarer asteroids & increase spawn)</h3>
        <button class="buyButton" data-type="scanner" data-cost="15" data-level="1">Radar Lv1 - $15</button>
      </div>

      <div class="store-section">
        <h3>Asteroid Value</h3>
        <p style="font-size:12px;opacity:.9;margin-bottom:6px;">Each purchase increases asteroid payouts by 1.5Ã— (multiplicative).</p>
        <button class="buyButton" data-type="value" data-cost="25" data-level="1">Value Lv1 - $25</button>
      </div>
    </div>

    <div id="moneyDisplay">Money: $0</div>
  </div>

  <script>
  // ---------- Core vars ----------
  const startButton = document.getElementById('startButton');
  const startScreen = document.getElementById('startScreen');
  const gameArea = document.getElementById('gameArea');
  const menuHeight = 50;

  const shopToggle = document.getElementById('shopToggle');
  const statsToggle = document.getElementById('statsToggle');
  const achToggle = document.getElementById('achToggle');
  const storeMenu = document.getElementById('storeMenu');
  const statsMenu = document.getElementById('statsMenu');
  const achievementsMenu = document.getElementById('achievementsMenu');
  const achievementsList = document.getElementById('achievementsList');
  const closeAchievements = document.getElementById('closeAchievements');
  const moneyDisplay = document.getElementById('moneyDisplay');
  const viewSecretsBtn = document.getElementById('viewSecretsBtn');
  const secretsPanel = document.getElementById('secretsPanel');
  const secretsList = document.getElementById('secretsList');
  const closeSecrets = document.getElementById('closeSecrets');
  
  const settingsBtn = document.getElementById("settingsBtn");
const settingsMenu = document.getElementById("settingsMenu");
const pauseButton = document.getElementById("pauseButton");
const restartButton = document.getElementById("restartButton");
const restartConfirm = document.getElementById("restartConfirm");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const saveButton = document.getElementById("saveButton");



  let activeCircles = [];
  let timerInterval = null;

  // settings

  let isPaused = false;

  // Stats
  let money = 0;
  let totalMoneyEarned = 0;
  let moneySpent = 0;
  let asteroidsDestroyed = 0;
  let upgradesPurchased = 0;
  let secondsPlayed = 0;
  let totalEvents = 0;
  let allyCount = 0;
  let aliensDestroyed = 0;

  // upgrades
  let upgrades = { weapon: 0, scanner: 0, value: 0 };
  let weaponLevel = 0;

  // --- payout now uses multiplicative 1.5x per 'value' upgrade ---
  function payoutForBase(base){
    const level = Math.max(0, upgrades.value || 0);
    const multiplier = Math.pow(1.5, level); // 1.5x per upgrade
    return Math.max(1, Math.round(base * multiplier));
  }

  const MAX_ACTIVE_ASTEROIDS = 5;
  const BASE_SPAWN_INTERVAL_MS = 1000;
  const BASE_SPAWN_PROB = 0.28;
  const COST_GROWTH = 2;
  const DEFAULT_ASTEROID_HP = 10;
  const MONEY_PER_HIT = 0;

  const ASTEROID_TYPES = [
    { id: 'normal', label: 'Normal', color: '#9b6b49', hp: 10, reward: 1 },
    { id: 'green', label: 'Green', color: '#6ba37a', hp: 15, reward: 2 },
    { id: 'blue',  label: 'Blue',  color: '#4aa3ff', hp: 25, reward: 5 },
    { id: 'purple',label: 'Purple',color: '#b76fb3', hp: 40, reward: 10 }
  ];

  const achievements = [
    { id: 'ach1', title: 'Asteroid Rookie', desc: 'Destroy 5 asteroids.', reward: 10, unlocked: false, claimed: false, condition: () => asteroidsDestroyed >= 5, hiddenTitle: false },
    { id: 'ach2', title: 'First Blood', desc: 'Destroy your 1st asteroid.', reward: 8, unlocked: false, claimed: false, condition: () => asteroidsDestroyed >= 1, hiddenTitle: false },
    { id: 'ach3', title: 'Rock Crusher', desc: 'Destroy 20 asteroids.', reward: 20, unlocked: false, claimed: false, condition: () => asteroidsDestroyed >= 20, hiddenTitle: false },
    { id: 'ach4', title: 'Destroyer', desc: 'Destroy 50 asteroids.', reward: 60, unlocked: false, claimed: false, condition: () => asteroidsDestroyed >= 50, hiddenTitle: true },
    { id: 'ach5', title: 'Laser Tech', desc: 'Purchase 1 weapon upgrade.', reward: 10, unlocked: false, claimed: false, condition: () => upgrades.weapon >= 1, hiddenTitle: false },
    { id: 'ach6', title: 'Radar Expert', desc: 'Purchase 1 scanner upgrade.', reward: 10, unlocked: false, claimed: false, condition: () => upgrades.scanner >= 1, hiddenTitle: false },
    { id: 'ach7', title: 'Engineer', desc: 'Purchase 5 upgrades total.', reward: 25, unlocked: false, claimed: false, condition: () => upgradesPurchased >= 5, hiddenTitle: false },
    { id: 'ach8', title: 'Collector', desc: 'Earn $100 total.', reward: 25, unlocked: false, claimed: false, condition: () => totalMoneyEarned >= 100, hiddenTitle: false },
    { id: 'ach9', title: 'Tycoon', desc: 'Earn $500 total.', reward: 50, unlocked: false, claimed: false, condition: () => totalMoneyEarned >= 500, hiddenTitle: true },
    { id: 'ach10', title: 'Marathon Pilot', desc: 'Play for 5 minutes.', reward: 15, unlocked: false, claimed: false, condition: () => secondsPlayed >= 300, hiddenTitle: false },
    { id: 'ach11', title: 'Lucky Break', desc: 'Destroy 3 asteroids in under 10 seconds.', reward: 30, unlocked: false, claimed: false, condition: () => false, hiddenTitle: true, special: { type:'speed_kill', window:10, needed:3 } },
    { id: 'ach12', title: 'Team Builder', desc: 'Reach 3 allies.', reward: 20, unlocked: false, claimed: false, condition: () => allyCount >= 3, hiddenTitle: false },
    { id: 'ach13', title: 'Alien Menace', desc: 'Destroy 10 aliens.', reward: 40, unlocked: false, claimed: false, condition: () => aliensDestroyed >= 10, hiddenTitle: true },
    { id: 'ach14', title: 'Event Hunter', desc: 'Trigger 10 total events.', reward: 30, unlocked: false, claimed: false, condition: () => totalEvents >= 10, hiddenTitle: false },
    { id: 'ach15', title: 'Completionist', desc: 'Unlock all achievements.', reward: 150, unlocked: false, claimed: false, condition: () => achievements.every(a => a.unlocked), hiddenTitle: true }
  ];

  const secrets = [
    { id: 's1', name: '??????', revealed:false, collected:false, hint:'First asteroid destroyed', reward:12, image:'ðŸª¨', unlockReason:'first_asteroid' },
    { id: 's2', name: '??????', revealed:false, collected:false, hint:'First upgrade purchased', reward:15, image:'â˜„ï¸', unlockReason:'first_upgrade' },
    { id: 's3', name: '??????', revealed:false, collected:false, hint:'Small random discovery', reward:20, image:'ðŸŒ‘', unlockReason:'random_hit' },
    { id: 's4', name: '??????', revealed:false, collected:false, hint:'Play for 5 minutes', reward:40, image:'ðŸŒ ', unlockReason:'time_played_300' },
    { id: 's5', name: '??????', revealed:false, collected:false, hint:'Earn a decent fortune', reward:50, image:'ðŸ’ ', unlockReason:'earn_money_500' },
    { id: 's6', name: '??????', revealed:false, collected:false, hint:'Rare random event', reward:80, image:'ðŸŒ’', unlockReason:'rare_random' },
    { id: 's7', name: '??????', revealed:false, collected:false, hint:'Unlock 5 achievements', reward:60, image:'ðŸŒ˜', unlockReason:'achievements_5' },
    { id: 's8', name: '??????', revealed:false, collected:false, hint:'Destroy 100 asteroids', reward:100, image:'ðŸŒ•', unlockReason:'asteroids_100' },
    { id: 's9', name: '??????', revealed:false, collected:false, hint:'Unlock all secrets', reward:120, image:'â˜„ï¸', unlockReason:'all_secrets' },
    { id: 's10', name: '??????', revealed:false, collected:false, hint:'Ultimate completion bonus', reward:200, image:'ðŸ’°', unlockReason:'everything_complete' }
  ];

  let recentKillsTimestamps = [];

  function updateStatsUI(){
    document.getElementById('totalMoneyEarned').textContent = `$${totalMoneyEarned}`;
    document.getElementById('moneySpent').textContent = `$${moneySpent}`;
    document.getElementById('asteroidsDestroyed').textContent = asteroidsDestroyed;
    document.getElementById('upgradesPurchased').textContent = upgradesPurchased;
    const minutes = Math.floor(secondsPlayed/60);
    const seconds = secondsPlayed % 60;
    document.getElementById('timePlayed').textContent = `${minutes}:${String(seconds).padStart(2,'0')}`;
    moneyDisplay.textContent = `Money: $${money}`;
  }

  function renderAchievements(){
    achievementsList.innerHTML = '';
    achievements.forEach(a => {
      const card = document.createElement('div'); card.className='achievement-card';
      const title = document.createElement('div'); title.className='achievement-title';
      const desc = document.createElement('div'); desc.className='achievement-desc';
      if (!a.unlocked && a.hiddenTitle){ title.textContent='??????'; desc.textContent='Unlock to reveal this achievement.'; card.classList.add('locked'); }
      else { title.textContent = a.title; desc.textContent = a.desc; }
      const progressWrap = document.createElement('div'); progressWrap.className='progressBarWrap';
      const progress = document.createElement('div'); progress.className='progressBar';
      let pct = 0;
      if (a.id==='ach1') pct = Math.min(1, asteroidsDestroyed/5);
      else if (a.id==='ach3') pct = Math.min(1, asteroidsDestroyed/20);
      else if (a.id==='ach4') pct = Math.min(1, asteroidsDestroyed/50);
      else if (a.id==='ach8') pct = Math.min(1, totalMoneyEarned/100);
      else if (a.id==='ach9') pct = Math.min(1, totalMoneyEarned/500);
      else if (a.id==='ach7') pct = Math.min(1, upgradesPurchased/5);
      else if (a.id==='ach10') pct = Math.min(1, secondsPlayed/300);
      else if (a.id==='ach14') pct = Math.min(1, totalEvents/10);
      else if (a.id==='ach12') pct = Math.min(1, allyCount/3);
      else pct = (a.unlocked?1:0);
      progress.style.width = `${Math.floor(pct*100)}%`;
      progressWrap.appendChild(progress);

      const statusRow = document.createElement('div'); statusRow.style.display='flex'; statusRow.style.justifyContent='space-between'; statusRow.style.alignItems='center'; statusRow.style.marginTop='8px';
      const rewardText = document.createElement('div'); rewardText.style.fontSize='12px'; rewardText.style.opacity='.9'; rewardText.textContent = `Reward: $${a.reward}`;
      const claimBtn = document.createElement('button'); claimBtn.className='claimButton'; claimBtn.textContent = a.claimed ? 'Claimed' : `Claim ($${a.reward})`; claimBtn.disabled = !a.unlocked || a.claimed;
      claimBtn.addEventListener('click', ()=>{
        if (a.unlocked && !a.claimed){ money += a.reward; totalMoneyEarned += a.reward; a.claimed = true; updateStatsUI(); renderAchievements(); maybeUnlockSecret('achievement_unlocked'); }
      });

      card.appendChild(title); card.appendChild(desc); card.appendChild(progressWrap);
      statusRow.appendChild(rewardText); statusRow.appendChild(claimBtn); card.appendChild(statusRow);
      achievementsList.appendChild(card);
    });
  }

  function renderSecrets(){
    secretsList.innerHTML = '';
    secrets.forEach(s=>{
      const card = document.createElement('div'); card.className='secret-card';
      const img = document.createElement('div'); img.className='secret-image'; img.textContent = s.revealed ? s.image : '???'; if(!s.revealed) img.classList.add('locked');
      const text = document.createElement('div'); text.style.flex='1';
      const t = document.createElement('div'); t.className='secret-title'; t.textContent = s.revealed ? s.name : '??????';
      const sub = document.createElement('div'); sub.className='secret-sub'; sub.textContent = s.revealed ? `Discovered: ${s.hint}` : 'Locked secret - discover by playing!';
      text.appendChild(t); text.appendChild(sub);
      const btn = document.createElement('button'); btn.className='secret-button'; btn.textContent = s.collected ? 'Collected' : (s.revealed ? `Collect ($${s.reward})` : 'Locked'); btn.disabled = !s.revealed || s.collected;
      btn.addEventListener('click', ()=>{ if (s.revealed && !s.collected){ money += s.reward; totalMoneyEarned += s.reward; s.collected = true; updateStatsUI(); renderSecrets(); maybeUnlockSecret('secret_collected'); } });
      card.appendChild(img); card.appendChild(text); card.appendChild(btn);
      secretsList.appendChild(card);
    });
  }

  function checkAchievements(){
    let any=false;
    achievements.forEach(a=>{
      if(!a.unlocked){
        if(typeof a.condition === 'function' && a.condition()){ a.unlocked = true; any = true; }
        else if(a.special && a.special.type === 'speed_kill'){ /* handled on kill */ }
        else if(a.id==='ach15' && a.condition()){ a.unlocked = true; any = true; }
      }
    });
    if(any) renderAchievements();
  }

  function revealSecretById(id, revealName){
    const s = secrets.find(x=>x.id===id); if(!s) return; if(!s.revealed){ s.revealed = true; if(revealName) s.name = revealName; renderSecrets(); }
  }

  function maybeUnlockSecret(trigger){
    if (trigger === 'purchase' || trigger === 'first_upgrade') {
      if (!secrets[1].revealed) revealSecretById('s2','Forged in Fire');
      if (!secrets[2].revealed && Math.random() < 0.12) revealSecretById('s3','Hidden Pebble');
    } else if (trigger === 'random_hit' || trigger === 'first_asteroid') {
      if (trigger === 'first_asteroid' && !secrets[0].revealed) revealSecretById('s1','First Light');
      if (!secrets[2].revealed && Math.random() < 0.08) revealSecretById('s3','Hidden Pebble');
      if (!secrets[5].revealed && Math.random() < 0.02) revealSecretById('s6','Lucky Fragment');
    } else if (trigger === 'time_played') {
      if (!secrets[3].revealed && secondsPlayed >= 300) revealSecretById('s4','Hidden Transmission');
      if (!secrets[2].revealed && secondsPlayed >= 60 && Math.random() < 0.05) revealSecretById('s3','Hidden Pebble');
    } else if (trigger === 'earn_money') {
      if (!secrets[4].revealed && totalMoneyEarned >= 500) revealSecretById('s5','Hidden Fortune');
    } else if (trigger === 'achievement_unlocked') {
      const unlockedCount = achievements.filter(a=>a.unlocked).length;
      if (!secrets[6].revealed && unlockedCount >= 5) revealSecretById('s7','The Overseer');
      if (!secrets[8].revealed && secrets.filter(s=>s.revealed).length >= 9) revealSecretById('s9',"Collector's Echo");
    } else if (trigger === 'secret_collected') {
      const collectedCount = secrets.filter(s=>s.collected).length;
      if (!secrets[8].revealed && collectedCount >= 9) revealSecretById('s9',"Collector's Echo");
    } else if (trigger === 'rare_random') {
      if (!secrets[5].revealed && Math.random() < 0.007) revealSecretById('s6','Lucky Fragment');
    }

    if (!secrets[7].revealed && asteroidsDestroyed >= 100) revealSecretById('s8','Enduring Impact');
    if (!secrets[9].revealed && achievements.every(a=>a.unlocked) && secrets.every(s=>s.revealed)) revealSecretById('s10','Everything Revealed');
    if (!secrets[8].revealed && secrets.filter(s=>s.revealed).length >= 9) revealSecretById('s9',"Collector's Echo");
  }

  function unlockSecret(key){ maybeUnlockSecret(key); }

  const SCANNER_PROB_TABLE = {
    0: [{ id:'normal', p:1 }],
    1: [{ id:'normal', p:0.8 }, { id:'green', p:0.2 }],
    2: [{ id:'normal', p:0.6 }, { id:'green', p:0.25 }, { id:'blue', p:0.15 }],
    3: [{ id:'normal', p:0.4 }, { id:'green', p:0.3 }, { id:'blue', p:0.2 }, { id:'purple', p:0.1 }]
  };

  function chooseAsteroidType(scannerLevel){
    const level = Math.max(0, Math.min(3, scannerLevel));
    const table = SCANNER_PROB_TABLE[level] || SCANNER_PROB_TABLE[3];
    const r = Math.random();
    let acc = 0;
    for (let i=0;i<table.length;i++){
      acc += table[i].p;
      if (r <= acc) {
        const picked = ASTEROID_TYPES.find(t => t.id === table[i].id);
        return Object.assign({}, picked);
      }
    }
    return Object.assign({}, ASTEROID_TYPES[0]);
  }

  function randomEdgePosition(rect){
    const edge = Math.floor(Math.random()*4);
    let x,y,dx,dy;
    switch(edge){
      case 0: x = Math.random()*(rect.width-48); y = menuHeight; dx = (Math.random()-0.5)*2; dy = 1; break;
      case 1: x = rect.width - 48; y = Math.random()*(rect.height-48-menuHeight) + menuHeight; dx = -1; dy = (Math.random()-0.5)*2; break;
      case 2: x = Math.random()*(rect.width-48); y = rect.height - 48; dx = (Math.random()-0.5)*2; dy = -1; break;
      default: x = 0; y = Math.random()*(rect.height-48-menuHeight) + menuHeight; dx = 1; dy = (Math.random()-0.5)*2; break;
    }
    const MIN_SPEED = 0.18, MAX_SPEED = 0.6;
    const speed = MIN_SPEED + Math.random()*(MAX_SPEED-MIN_SPEED);
    const len = Math.sqrt(dx*dx + dy*dy) || 1;
    dx = (dx/len)*speed; dy = (dy/len)*speed;
    return { x,y,dx,dy };
  }

  function createMovingCircle(options){
    if (isPaused) return;
    if (activeCircles.length >= MAX_ACTIVE_ASTEROIDS) return;
    const rect = gameArea.getBoundingClientRect();
    const { x,y,dx,dy } = randomEdgePosition(rect);
    let posX = x, posY = y;

    const type = options && options.typeOverride ? options.typeOverride : chooseAsteroidType(upgrades.scanner);

    const circle = document.createElement('div'); circle.className='circle';
    circle.style.left = `${posX}px`; circle.style.top = `${posY}px`;
    circle.style.backgroundColor = type.color;
    circle.title = `${type.label}`;

    const hpBar = document.createElement('div'); hpBar.className='hp-bar';
    const hpInner = document.createElement('div'); hpInner.className='hp-bar-inner';
    hpBar.appendChild(hpInner);
    const hpText = document.createElement('div'); hpText.style.pointerEvents='none'; hpText.style.fontSize='11px'; hpText.style.textShadow='0 1px 1px rgba(0,0,0,0.6)';
    circle.appendChild(hpBar); circle.appendChild(hpText);

    const hpVal = (options && typeof options.hpOverride === 'number') ? options.hpOverride : (type.hp || DEFAULT_ASTEROID_HP);
    const baseReward = (options && typeof options.rewardOverride === 'number') ? options.rewardOverride : (type.reward || 1);
    const rewardVal = payoutForBase(baseReward);

    const hpObj = { hp: hpVal, maxHp: hpVal, reward: rewardVal, typeId: type.id, label: type.label };

    function refreshHpUI(){
      const pct = Math.max(0, hpObj.hp / hpObj.maxHp);
      hpInner.style.width = `${Math.floor(pct*100)}%`;
      hpText.textContent = Math.round(hpObj.hp);
      circle.style.filter = `brightness(${0.65 + pct*0.6})`;
    }
    refreshHpUI();

    circle.addEventListener('click', (evt)=>{
      evt.stopPropagation();
      const dmg = 1 + (Number(weaponLevel) || 0);
      hpObj.hp = Math.max(0, Number(hpObj.hp) - dmg);
      if (MONEY_PER_HIT > 0){ money += MONEY_PER_HIT; totalMoneyEarned += MONEY_PER_HIT; }
      refreshHpUI();

      if (hpObj.hp <= 0){
        const rewardGiven = Math.round(hpObj.reward);
        money += rewardGiven;
        totalMoneyEarned += rewardGiven;
        asteroidsDestroyed += 1;
        totalEvents += 1;
        moneyDisplay.textContent = `Money: $${money}`;
        updateStatsUI();

        recentKillsTimestamps.push(Date.now());
        const now = Date.now();
        recentKillsTimestamps = recentKillsTimestamps.filter(t => now - t <= 10000);
        const ach11 = achievements.find(a=>a.id==='ach11');
        if (!ach11.unlocked && recentKillsTimestamps.length >= (ach11.special?.needed || 3)) {
          ach11.unlocked = true; ach11.hiddenTitle = false; renderAchievements(); maybeUnlockSecret('achievement_unlocked');
        }

        checkAchievements();
        unlockSecret('random_hit');
        unlockSecret('earn_money');
        if (asteroidsDestroyed === 1) unlockSecret('first_asteroid');
        if (Math.random() < 0.01) unlockSecret('rare_random');

        circle.remove();
        activeCircles = activeCircles.filter(c => c.el !== circle);
      }
    });

    gameArea.appendChild(circle);
    activeCircles.push({ el: circle, x: posX, y: posY, dx, dy, hpObj });
  }

  function animateCircles(){
    const rect = gameArea.getBoundingClientRect();
    for (let i = activeCircles.length - 1; i >= 0; i--){
      const c = activeCircles[i];
        if (!isPaused) {
      c.x += c.dx; c.y += c.dy;
      c.el.style.left = `${c.x}px`; c.el.style.top = `${c.y}px`;
        }
      if (c.x < -80 || c.x > rect.width + 80 || c.y < menuHeight - 80 || c.y > rect.height + 80){
        c.el.remove(); activeCircles.splice(i,1);
      }
    }
    requestAnimationFrame(animateCircles);
  }

  function startTimer(){
    if (timerInterval) return;
    timerInterval = setInterval(()=>{
      if (isPaused) return; // <-- skip everything while paused
      secondsPlayed++; updateStatsUI();
      const scannerFactor = 1 + (0.18 * upgrades.scanner);
      const effectiveSpawnProb = Math.min(0.9, BASE_SPAWN_PROB * scannerFactor);
      if (Math.random() < effectiveSpawnProb){
        if (activeCircles.length < MAX_ACTIVE_ASTEROIDS) createMovingCircle();
      }
    }, BASE_SPAWN_INTERVAL_MS);
  }

  pauseButton.addEventListener("click", () => {
  isPaused = !isPaused;
  pauseButton.textContent = isPaused ? " Resume" : " Pause";
  const gameArea = document.getElementById("gameArea");
  gameArea.style.opacity = isPaused ? "0.5" : "1";
  if (!isPaused) {
    createMovingCircle();
  }
});

  shopToggle.addEventListener('click', (e)=>{
    storeMenu.style.display = storeMenu.style.display === 'block' ? 'none' : 'block';
    e.stopPropagation();
  });
  statsToggle.addEventListener('click', (e)=>{ statsMenu.style.display = statsMenu.style.display === 'block' ? 'none' : 'block'; e.stopPropagation(); });
  achToggle.addEventListener('click', (e)=>{
    const visible = achievementsMenu.style.display === 'block';
    achievementsMenu.style.display = visible ? 'none' : 'block';
    if (!visible){ renderAchievements(); renderSecrets(); }
    e.stopPropagation();
  });

  settingsBtn.addEventListener("click", (e) => {
   e.stopPropagation(); // prevent click from closing immediately
   const isVisible = settingsMenu.style.display === "block";
  settingsMenu.style.display = isVisible ? "none" : "block";
  });
  

  document.addEventListener('click', (e)=>{
    if (storeMenu.style.display === 'block' && !storeMenu.contains(e.target) && e.target !== shopToggle) {
      storeMenu.style.display = 'none';
    }
    if (statsMenu.style.display === 'block' && !statsMenu.contains(e.target) && e.target !== statsToggle) {
      statsMenu.style.display = 'none';
    }
    if (achievementsMenu.style.display === 'block' && !achievementsMenu.contains(e.target) && e.target !== achToggle) {
      achievementsMenu.style.display = 'none';
      secretsPanel.classList.remove('open');
      secretsPanel.setAttribute('aria-hidden','true');
    }
    if (secretsPanel.classList.contains('open') && !secretsPanel.contains(e.target) && !achievementsMenu.contains(e.target) && e.target !== viewSecretsBtn) {
      secretsPanel.classList.remove('open');
      secretsPanel.setAttribute('aria-hidden','true');
    }
  });

  [storeMenu, statsMenu, achievementsMenu, secretsPanel].forEach(el=>{
    el.addEventListener('click', (ev)=>{ ev.stopPropagation(); });
  });

  closeAchievements.addEventListener('click', ()=>{ achievementsMenu.style.display = 'none'; secretsPanel.classList.remove('open'); secretsPanel.setAttribute('aria-hidden','true'); });
  viewSecretsBtn.addEventListener('click', ()=>{ secretsPanel.classList.add('open'); secretsPanel.setAttribute('aria-hidden','false'); });
  closeSecrets.addEventListener('click', ()=>{ secretsPanel.classList.remove('open'); secretsPanel.setAttribute('aria-hidden','true'); });

  function fmt(n){ return Number(n).toFixed(0); }

  document.querySelectorAll('.buyButton').forEach(button=>{
    button.dataset.cost = String(Number(button.dataset.cost) || 10);
    button.dataset.level = String(Number(button.dataset.level) || 1);
    button.dataset.purchases = String(Number(button.dataset.purchases) || 0);
    button.dataset.origText = button.textContent.trim();

    function updateButtonLabel(btn){
      const type = btn.dataset.type;
      const cost = Number(btn.dataset.cost);
      const purchases = Number(btn.dataset.purchases);
      if (type === 'weapon'){
        btn.textContent = `Laser Lv${upgrades.weapon + 1} - $${fmt(cost)}`;
      } else if (type === 'scanner'){
        btn.textContent = `Radar Next Lv${upgrades.scanner + 1} - $${fmt(cost)}`;
      } else if (type === 'value'){
        btn.textContent = `Value Lv${purchases + 1} - $${fmt(cost)}`;
      } else {
        btn.textContent = `${btn.dataset.origText} - $${fmt(cost)}`;
      }
    }
    updateButtonLabel(button);

    button.addEventListener('click', (e)=>{
      if (button.disabled) return;
      const cost = Number(button.dataset.cost);
      const type = button.dataset.type;
      let purchases = Number(button.dataset.purchases);

      if (money >= cost) {
        money -= cost;
        moneySpent += cost;
        upgradesPurchased += 1;
        purchases += 1;
        button.dataset.purchases = String(purchases);

        if (type === 'weapon') {
          upgrades.weapon = upgrades.weapon + 1;
          weaponLevel = upgrades.weapon;
        } else if (type === 'scanner') {
          upgrades.scanner = upgrades.scanner + 1;
        } else if (type === 'value') {
          upgrades.value = upgrades.value + 1;
        }

        const nextCost = Math.max(1, Math.round(cost * COST_GROWTH));
        button.dataset.cost = String(nextCost);
        button.dataset.level = String(Number(button.dataset.level) + 1);

        updateStatsUI();
        updateButtonLabel(button);

        totalEvents++;
        checkAchievements();
        maybeUnlockSecret('purchase');
        if (upgrades.weapon + upgrades.scanner + upgrades.value === 1) maybeUnlockSecret('first_upgrade');
        renderAchievements(); renderSecrets();
      } else {
        button.style.transform = 'scale(0.98)';
        setTimeout(()=>{ button.style.transform = ''; }, 120);
      }

      e.stopPropagation();
    });
  });
  
  document.addEventListener("DOMContentLoaded", () => {
  loadGame();
});

  setInterval(()=>{
    checkAchievements();
    maybeUnlockSecret('time_played');
    maybeUnlockSecret('earn_money');
    renderAchievements();
    renderSecrets();
  }, 2000);

  startButton.addEventListener('click', ()=>{
    startTimer();
    startScreen.style.display = 'none';
    gameArea.style.display = 'block';
    activeCircles = [];
    createMovingCircle();
    createMovingCircle();
    animateCircles();
    updateStatsUI();
  });

  saveButton.addEventListener("click", () => {
  const saveData = {
    money,
    weaponLevel,
    upgrades,
    asteroidsDestroyed,
    secondsPlayed,
    totalMoneyEarned,
    moneySpent,
    upgradesPurchased,
    totalEvents,
    allyCount,
    
   
    
    
    // you could add more here
  };

  localStorage.setItem("myGameSave", JSON.stringify(saveData));
  alert("Game saved!");
});

  function loadGame() {
  const saved = localStorage.getItem("myGameSave");
  if (saved) {
    const data = JSON.parse(saved);
    money = data.money || 0;
    weaponLevel = data.weaponLevel || 0;
    upgrades = data.upgrades || {};
    asteroidsDestroyed = data.asteroidsDestroyed || 0;
    secondsPlayed = data.secondsPlayed || 0;
    totalMoneyEarned = data.totalMoneyEarned || 0;
    moneySpent = data.moneySpent || 0;
    upgradesPurchased = data.upgradesPurchased || 0;
    totalEvents = data.totalEvents || 0;
    allyCount = data.ally || 0;
    
    updateButtonLabel(weapon);
    updateButtonLabel(scanner);
    updateButtonLabel(value);

  }
}

  restartButton.addEventListener("click", () => {
  restartConfirm.style.display = "block";
});

confirmNo.addEventListener("click", () => {
  restartConfirm.style.display = "none";
});

  confirmYes.addEventListener("click", () => {
 
  money = 0; totalMoneyEarned = 0; moneySpent = 0; asteroidsDestroyed = 0; upgradesPurchased = 0; secondsPlayed = 0; totalEvents = 0; allyCount = 0; aliensDestroyed = 0; upgrades = { weapon: 0, scanner: 0, value: 0 }; weaponLevel = 0;

  achievements.forEach(a => { a.unlocked = false; a.claimed = false; a.hiddenTitle = !!a.hiddenTitle; });
  secrets.forEach(s => { s.revealed = false; s.collected = false; });
  activeCircles.forEach(c => c.el.remove());
  activeCircles = [];

  isPaused = false;
  pauseButton.textContent = " Pause";
  gameArea.style.opacity = "1";
  clearInterval(timerInterval);
  timerInterval = null;
  startTimer();
  createMovingCircle();
  createMovingCircle();
  
});

  updateStatsUI();
  renderAchievements();
  renderSecrets();
  </script>
</body>
</html>